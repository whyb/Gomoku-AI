<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº”å­æ£‹AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2C3E50',
                        secondary: '#E67E22',
                        wood: '#DDBB8E',
                        line: '#855E42',
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .board-wrapper {
                @apply relative w-full aspect-square bg-wood shadow-2xl rounded-sm;
                max-width: min(90vw, 600px);
                margin: 0 auto;
            }
            .grid-container {
                @apply absolute inset-0;
                padding: 3.3333%; 
                display: grid;
                grid-template-columns: repeat(14, 1fr);
                grid-template-rows: repeat(14, 1fr);
            }
            .grid-cell { @apply border-l border-t border-line; }
            .grid-cell-right { @apply border-r border-line; }
            .grid-cell-bottom { @apply border-b border-line; }

            .interaction-layer {
                @apply absolute inset-0 z-10;
                display: grid;
                grid-template-columns: repeat(15, 1fr);
                grid-template-rows: repeat(15, 1fr);
            }

            .intersect-point {
                @apply flex items-center justify-center cursor-pointer relative;
                -webkit-tap-highlight-color: transparent;
            }

            .piece {
                @apply rounded-full shadow-lg transform scale-0 transition-transform duration-200 z-10;
                width: 80%;
                height: 80%;
            }
            .piece-black { background: radial-gradient(circle at 30% 30%, #444, #000); }
            .piece-white { background: radial-gradient(circle at 30% 30%, #fff, #ccc); }
            .piece-visible { @apply scale-100; }
            
            .last-move-cursor {
                @apply absolute inset-0 border-2 border-red-400/60 rounded-sm pointer-events-none z-20;
                box-shadow: 0 0 4px rgba(248, 113, 113, 0.6);
                animation: pulse-border 1.5s infinite;
            }

            @keyframes pulse-border {
                0% { opacity: 0.4; transform: scale(0.95); }
                50% { opacity: 1; transform: scale(1.05); }
                100% { opacity: 0.4; transform: scale(0.95); }
            }
        }
    </style>
</head>
<body class="bg-[#F4F1EA] min-h-screen flex flex-col items-center py-6 px-4 font-sans text-primary">
    
    <div class="w-full max-w-[600px] mb-4 flex flex-col gap-4">
        <div class="flex justify-between items-start px-2">
            <div>
                <h1 class="text-2xl md:text-3xl font-serif font-bold tracking-tight">äº”å­æ£‹ <span class="text-secondary font-sans">AI</span></h1>
                <p class="text-[10px] uppercase tracking-[0.2em] opacity-50 text-line">Professional ResNet Engine</p>
            </div>
            <a href="https://github.com/whyb/Gomoku-AI/" target="_blank" class="flex items-center gap-2 bg-white/40 px-3 py-1.5 rounded-full border border-white/60 hover:bg-white/80 transition-all shadow-sm">
                <i class="fa fa-github text-lg"></i>
                <span class="text-xs font-bold hidden sm:inline">å…³äºæœ¬é¡¹ç›®</span>
            </a>
        </div>
        
        <div class="flex justify-between items-center bg-white/60 backdrop-blur-sm p-3 rounded-xl shadow-sm border border-white/40">
            <div class="flex gap-4">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full piece-black shadow-sm"></div>
                    <span class="text-xs font-bold">ç©å®¶</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full piece-white shadow-sm"></div>
                    <span class="text-xs font-bold">AI</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <label class="flex items-center cursor-pointer gap-2">
                    <input type="checkbox" id="aiFirst" class="w-4 h-4 rounded border-gray-300 text-secondary focus:ring-secondary" checked>
                    <span class="text-[11px] font-medium">AIå…ˆæ‰‹</span>
                </label>
                <div class="h-4 w-px bg-gray-300 mx-1"></div>
                <button id="restart" class="bg-primary text-white text-[11px] px-3 py-1.5 rounded-lg hover:bg-secondary transition-colors shadow-sm">
                    é‡ç½®æ¸¸æˆ
                </button>
            </div>
        </div>
        
        <div id="status" class="text-center text-xs font-bold tracking-widest text-secondary uppercase animate-pulse">
            æ­£åœ¨åˆå§‹åŒ–å¼•æ“...
        </div>
    </div>

    <div class="board-wrapper">
        <div id="grid-bg" class="grid-container"></div>
        <div id="board" class="interaction-layer"></div>
    </div>

    <div id="resultModal" class="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-6 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-xs w-full text-center shadow-2xl transform transition-all scale-110">
            <div id="resultIcon" class="text-5xl mb-4">ğŸ†</div>
            <h3 id="resultTitle" class="text-2xl font-bold mb-2">æ­å–œè·èƒœï¼</h3>
            <p id="resultMsg" class="text-sm text-gray-500 mb-8">è¿™åœºå¯¹å¼ˆéå¸¸ç²¾å½©ã€‚</p>
            <div class="flex flex-col gap-3">
                <button id="btnPlayAgain" class="w-full bg-secondary text-white py-3 rounded-xl font-bold hover:brightness-110 transition-all shadow-lg">å†æ¥ä¸€æŠŠ</button>
                <button id="btnCloseResult" class="w-full bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition-all">å…³é—­</button>
                
                <a href="https://github.com/whyb/Gomoku-AI/" target="_blank" class="mt-2 text-[11px] text-gray-400 hover:text-secondary underline underline-offset-4">
                    <i class="fa fa-code mr-1"></i>æŸ¥çœ‹å¼€æºä»£ç 
                </a>
            </div>
        </div>
    </div>

    <footer class="mt-8 text-[10px] text-gray-400 font-medium tracking-tighter opacity-60">
        POWERED BY ONNX RUNTIME WEB & TAILWIND CSS
    </footer>

    <div id="loading" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-secondary border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-sm font-bold tracking-widest text-primary/60">AIå¼•æ“åŠ è½½ä¸­...</p>
    </div>

    <script>
        const BOARD_SIZE = 15;
        const BOARD_SQUARE = BOARD_SIZE * BOARD_SIZE;
        
        let gameState = {
            board: Array(BOARD_SQUARE).fill(0),
            gameOver: false,
            model: null,
            isAIMoving: false,
            lastMove: -1
        };

        function drawGrid() {
            const gridContainer = document.getElementById('grid-bg');
            gridContainer.innerHTML = '';
            for (let i = 0; i < 14 * 14; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                if ((i + 1) % 14 === 0) cell.classList.add('grid-cell-right');
                if (i >= 14 * 13) cell.classList.add('grid-cell-bottom');
                gridContainer.appendChild(cell);
            }
        }

        function initInteractions() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            for (let i = 0; i < BOARD_SQUARE; i++) {
                const point = document.createElement('div');
                point.className = 'intersect-point';
                point.onclick = () => handleMove(i);
                board.appendChild(point);
            }
        }

        function handleMove(index) {
            if (gameState.gameOver || gameState.board[index] !== 0 || gameState.isAIMoving) return;
            
            placePiece(index, 1);
            if (checkGameOver(1)) return;

            gameState.isAIMoving = true;
            document.getElementById('status').innerText = 'AI æ­£åœ¨æ€è€ƒ...';
            setTimeout(aiLogic, 1);
        }

        function placePiece(index, player) {
            gameState.board[index] = player;
            gameState.lastMove = index;
            
            const points = document.getElementById('board').children;
            document.querySelectorAll('.last-move-cursor').forEach(el => el.remove());
            
            const piece = document.createElement('div');
            piece.className = `piece ${player === 1 ? 'piece-black' : 'piece-white'}`;
            points[index].appendChild(piece);
            
            const marker = document.createElement('div');
            marker.className = 'last-move-cursor';
            points[index].appendChild(marker);
            
            requestAnimationFrame(() => piece.classList.add('piece-visible'));
        }

        async function aiLogic() {
            try {
                let bestMove = -1;
                // AI å¼€å±€ç­–ç•¥ï¼šå¦‚æœæ£‹ç›˜æ˜¯ç©ºçš„ï¼Œä¸‹ä¸­å¿ƒ
                if (gameState.board.filter(x => x!==0).length === 0) {
                    bestMove = 112; 
                } else {
                    const input = new Float32Array(BOARD_SQUARE * 2).fill(0);
                    gameState.board.forEach((val, i) => {
                        if (val === 1) input[i] = 1;
                        if (val === 2) input[i + BOARD_SQUARE] = 1;
                    });
                    const tensor = new ort.Tensor('float32', input, [1, 2, BOARD_SIZE, BOARD_SIZE]);
                    const output = await gameState.model.run({ input: tensor });
                    const logits = output.policy_logits.data;
                    let maxVal = -Infinity;
                    for (let i = 0; i < BOARD_SQUARE; i++) {
                        if (gameState.board[i] === 0 && logits[i] > maxVal) {
                            maxVal = logits[i];
                            bestMove = i;
                        }
                    }
                }
                placePiece(bestMove, 2);
                if (!checkGameOver(2)) {
                    document.getElementById('status').innerText = 'è¯·è½å­...';
                    gameState.isAIMoving = false;
                }
            } catch (e) {
                console.error(e);
                document.getElementById('status').innerText = 'AI å¼•æ“å¼‚å¸¸';
            }
        }

        function checkGameOver(player) {
            const isWin = checkWinner(player);
            const isDraw = !isWin && gameState.board.every(x => x !== 0);

            if (isWin || isDraw) {
                gameState.gameOver = true;
                document.getElementById('status').innerText = isWin ? (player === 1 ? 'ä½ èµ¢äº†ï¼' : 'AI è·èƒœ') : 'å¹³å±€';
                document.getElementById('status').classList.remove('animate-pulse');
                
                setTimeout(() => {
                    const modal = document.getElementById('resultModal');
                    const title = document.getElementById('resultTitle');
                    const msg = document.getElementById('resultMsg');
                    const icon = document.getElementById('resultIcon');
                    
                    if (isWin) {
                        icon.innerText = player === 1 ? 'ğŸ‰' : 'ğŸ¤–';
                        title.innerText = player === 1 ? 'ä½ å¤ªå‰å®³äº†ï¼' : 'å“ˆå“ˆä½ è¾“äº†ï¼';
                        msg.innerText = player === 1 ? 'åœ¨å¯¹é˜µAIä¸­è·å¾—äº†èƒœåˆ©ã€‚' : 'ç»§ç»­åŠªåŠ›å§ï¼';
                    } else {
                        icon.innerText = 'ğŸ¤';
                        title.innerText = 'æ¡æ‰‹è¨€å’Œ';
                        msg.innerText = 'åŒæ–¹æ£‹åŠ›ç›¸å½“ã€‚';
                    }
                    modal.classList.remove('hidden');
                }, 1000);
                return true;
            }
            return false;
        }

        function checkWinner(p) {
            const b = gameState.board;
            const dirs = [[0,1], [1,0], [1,1], [1,-1]];
            for (let i = 0; i < BOARD_SQUARE; i++) {
                if (b[i] !== p) continue;
                const r = Math.floor(i / 15), c = i % 15;
                for (const [dr, dc] of dirs) {
                    let count = 1;
                    for (let s = 1; s < 5; s++) {
                        const nr = r + dr*s, nc = c + dc*s;
                        if (nr >= 0 && nr < 15 && nc >= 0 && nc < 15 && b[nr*15+nc] === p) count++;
                        else break;
                    }
                    if (count >= 5) return true;
                }
            }
            return false;
        }

        // æµè§ˆå™¨ç¯å¢ƒè¯Šæ–­åŠæ•™ç¨‹æç¤ºåŠŸèƒ½
        function showFixTutorial(error) {
            const ua = navigator.userAgent;
            const isMac = /Macintosh|Mac OS X/i.test(ua);
            let browser = "Chrome";
            if (ua.indexOf("Firefox") > -1) browser = "Firefox";
            else if (ua.indexOf("Edg") > -1) browser = "Edge";
            else if (ua.indexOf("OPR") > -1 || ua.indexOf("Opera") > -1) browser = "Opera";
            else if (ua.indexOf("Safari") > -1 && ua.indexOf("Chrome") === -1) browser = "Safari";

            const modal = document.getElementById('resultModal');
            const title = document.getElementById('resultTitle');
            const msg = document.getElementById('resultMsg');
            const icon = document.getElementById('resultIcon');

            icon.innerText = "ğŸ› ï¸";
            title.innerText = "ç¯å¢ƒé…ç½®å¼‚å¸¸";
            
            let tutorial = `<div class="text-left text-xs space-y-2 mt-4 overflow-y-auto max-h-60">
                <p class="font-bold text-red-500">æ£€æµ‹åˆ°è·¨åŸŸé”™è¯¯ (CORS)ï¼šæµè§ˆå™¨ç¦æ­¢ç›´æ¥ä»æœ¬åœ°æ–‡ä»¶åŠ è½½ AI æ¨¡å‹ã€‚</p>
                <hr/>`;

            if (browser === "Firefox") {
                tutorial += `
                    <p><b>Firefox ä¿®å¤æ–¹æ¡ˆï¼š</b></p>
                    <ol class="list-decimal ml-4">
                        <li>åœ°å€æ è¾“å…¥ <b>about:config</b> å¹¶å›è½¦</li>
                        <li>æœç´¢ <b>privacy.file_unique_origin</b></li>
                        <li>åŒå‡»åˆ‡æ¢ä¸º <b class="text-secondary">false</b></li>
                        <li>é‡å¯æµè§ˆå™¨å¹¶é‡æ–°æ‰“å¼€æ­¤ HTML</li>
                    </ol>`;
            } else if (browser === "Safari") {
                tutorial += `
                    <p><b>Safari ä¿®å¤æ–¹æ¡ˆï¼š</b></p>
                    <ol class="list-decimal ml-4">
                        <li>èœå•æ é€‰æ‹©â€œè®¾ç½®â€ -> â€œé«˜çº§â€</li>
                        <li>å‹¾é€‰â€œåœ¨èœå•æ ä¸­æ˜¾ç¤ºâ€˜å¼€å‘â€™èœå•â€</li>
                        <li>ç‚¹å‡»ä¸Šæ–¹èœå•æ â€œå¼€å‘â€ -> <b class="text-secondary">åœç”¨æœ¬åœ°æ–‡ä»¶é™åˆ¶</b></li>
                    </ol>`;
            } else {
                // Chrome, Edge, Opera æ ¸å¿ƒé€»è¾‘ç›¸ä¼¼
                const cmd = isMac 
                    ? `open -a "Google Chrome" --args --allow-file-access-from-files` 
                    : `chrome.exe --allow-file-access-from-files`;
                tutorial += `
                    <p><b>${browser} (Chromium) ä¿®å¤æ–¹æ¡ˆï¼š</b></p>
                    <p>1. <b>æ¨èæ–¹æ¡ˆï¼š</b> ä½¿ç”¨ VS Code çš„ <b>Live Server</b> æ’ä»¶æˆ–æ‰§è¡Œ <code>python -m http.server</code> å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨ã€‚</p>
                    <p>2. <b>ä¸´æ—¶æ–¹æ¡ˆï¼š</b> å®Œå…¨é€€å‡ºæµè§ˆå™¨ï¼Œåœ¨ç»ˆç«¯/å‘½ä»¤è¡Œè¿è¡Œï¼š</p>
                    <code class="block bg-gray-800 text-white p-2 rounded mt-1 break-all">${cmd}</code>`;
            }

            tutorial += `</div>`;
            msg.innerHTML = tutorial;
            
            document.getElementById('btnPlayAgain').innerText = "æŸ¥çœ‹åœ¨çº¿æ–‡æ¡£";
            document.getElementById('btnPlayAgain').onclick = () => window.open('https://github.com/whyb/Gomoku-AI/');
            modal.classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        ort.env.wasm.numThreads = 1;
        ort.env.wasm.simd = false;
        async function init() {
            drawGrid();
            initInteractions();
            try {
                gameState.model = await ort.InferenceSession.create('model_bs15_win5.onnx');
                document.getElementById('loading').classList.add('hidden');
                reset();
            } catch (e) {
                console.error(e);
                showFixTutorial(e);
            }
        }

        function reset() {
            gameState.board = Array(BOARD_SQUARE).fill(0);
            gameState.gameOver = false;
            gameState.isAIMoving = false;
            gameState.lastMove = -1;
            document.getElementById('resultModal').classList.add('hidden');
            document.getElementById('status').classList.add('animate-pulse');
            initInteractions();
            
            if (document.getElementById('aiFirst').checked) {
                gameState.isAIMoving = true;
                document.getElementById('status').innerText = 'AI æ€è€ƒå¼€å±€...';
                setTimeout(aiLogic, 1);
            } else {
                document.getElementById('status').innerText = 'æ‰§é»‘å…ˆè¡Œ';
            }
        }

        document.getElementById('restart').onclick = reset;
        document.getElementById('btnPlayAgain').onclick = reset;
        document.getElementById('btnCloseResult').onclick = () => document.getElementById('resultModal').classList.add('hidden');
        
        window.onload = init;
    </script>
</body>
</html>